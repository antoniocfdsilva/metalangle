# MetalANGLE Development

MetalANGLE provides OpenGL ES 2.0 and EGL 1.4 libraries.  You can use these to build and run OpenGL ES 2.0 applications on Mac and iOS that make uses of underlying Metal API.

## Development setup

### Version Control
ANGLE uses git for version control. If you are not familiar with git, helpful documentation can be found at [http://git-scm.com/documentation](http://git-scm.com/documentation).

### Required Tools
On all platforms:

 * [depot_tools](http://dev.chromium.org/developers/how-tos/install-depot-tools)
   * Required to generate projects and fetch third-party dependencies.
   * Provides gclient, GN and ninja tools.
 * [XCode](https://developer.apple.com/xcode/) for Clang and development files.
 * Bison and flex are not needed as we only support generating the translator grammar on Windows.

For MacOS build:

 * GN is the build system.  GYP support has been removed. GN is available through depot_tools installation.
 * Clang will be set up by the build system and used by default.

For iOS build:

 * An Xcode project named `OpenGLES.xcodeproj` is provided in `ios/xcode` directory.
 * GN is not used atm. The aim is eventually using GN to build iOS version as the rest of platfomrs.
 * Running and testing on iOS Simulator requires Xcode 11+ and MacOS Catalina (10.15+).

### Getting the source

```
git clone https://github.com/kakashidinho/metalangle
cd metalangle
python scripts/bootstrap.py
gclient sync
git checkout master
```

After running `gclient sync`, it may report some errors about failed to fetch "gs://chromium-clang-format ...". If this happens, open `DEPS` file in the root directory,
remove this code snippets:
```
  {
    'name': 'clang_format_mac',
    'pattern': '.',
    'condition': 'host_os == "mac" and not build_with_chromium',
    'action': [ 'download_from_google_storage',
                '--no_resume',
                '--platform=darwin',
                '--no_auth',
                '--bucket', 'chromium-clang-format',
                '-s', '{angle_root}/buildtools/mac/clang-format.sha1',
    ],
  },
```

### Building MacOS version
After getting the source successfully, you are ready to generate the ninja files:
```
gn gen out/Debug --ide=xcode --args='mac_deployment_target="10.13" angle_enable_metal=true'
```

GN will generate ninja files by default.  To change the default build options run `gn args out/Debug`.  Some commonly used options are:
```
target_cpu = "x64"  (or "x86")
is_clang = false    (to use system default compiler instead of clang)
is_debug = true     (enable debugging, true is the default)
```
You can open XCode workspace generated by GN in `out/Debug` folder to browse the code, as well as debugging the tests and sample applications.

For a release build run `gn args out/Release` and set `is_debug = false`.

For more information on GN run `gn help`.

Ninja can be used to compile with one of the following commands:
```
ninja -C out/Debug
ninja -C out/Release
```
Ninja automatically calls GN to regenerate the build files on any configuration change.
Ensure `depot_tools` is in your path as it provides ninja.

### Building iOS version
- Open `OpenGLES.xcodeproj` in `ios/xcode` folder.
- The target `MetalANGLE` will build OpenGL ES framework named `MetalANGLE.framework`.
- Note: in order to test sample apps on real devices. You have to change their Bundle Identifier in XCode to something you like, since only one development team can use one ID at a time. And this is global restriction across the globes. Once one person install the sample apps using his Apple developer profile, the ID configured will be registered for that developer only. And no other developers can use that ID to install to their device anymore.

## Application Development with ANGLE
This sections describes how to use ANGLE to build an OpenGL ES application.

### Choosing a Backend
ANGLE can use a variety of backing renderers based on platform.  On MacOS & iOS, it defaults to Metal.

ANGLE provides an EGL extension called `EGL_ANGLE_platform_angle` which allows uers to select which renderer to use at EGL initialization time by calling eglGetPlatformDisplayEXT with special enums. Details of the extension can be found in it's specification in `extensions/ANGLE_platform_angle.txt` and `extensions/ANGLE_platform_angle_*.txt` and examples of it's use can be seen in the ANGLE samples and tests, particularly `util/EGLWindow.cpp`.
Currently, iOS version cannot choose other renderer other than the default (Metal).

### To Use MetalANGLE in Your Application

Configure your build environment to have access to the `include` folder to provide access to the standard Khronos EGL and GLES2 header files.

On MacOS:

 - Configure your build environment to have access to `libEGL.dylib` and `libGLESv2.dylib` found in the build output directory (see [Building ANGLE](#Building-MacOS-version)).
 - Link you application against `libGLESv2.dylib` and `libEGL.dylib`.
 - Code your application to the Khronos [OpenGL ES 2.0](http://www.khronos.org/registry/gles/) and [EGL 1.4](http://www.khronos.org/registry/egl/) APIs.

On iOS:

 - Link you application against `MetalANGLE.framework`.
